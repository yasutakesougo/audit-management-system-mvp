#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# Pre-push hook: lightweight guard for development
# Full checks (lint, typecheck, build) run in CI via npm run preflight
#
# Strategy:
#   - Local: quick checks on changed files only (fast feedback)
#   - CI: full suite via preflight (complete enforcement)
#   - Never blocks if CI will catch it anyway

# Allow bypass: git push --no-verify
# Troubleshoot: run "npm run preflight" locally to match CI

if [ -n "$CI" ]; then
  # In CI: npm run preflight already handles everything
  # This hook is not typically called during CI push, but if it is, skip it
  exit 0
fi

# Local development: check only changed files to keep it fast
# Include: Added, Created, Modified, Renamed (ACMR)
FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$' || true)

# If no TypeScript/JavaScript files staged, nothing to check
if [ -z "$FILES" ]; then
  exit 0
fi

echo "[pre-push] Lint staged TypeScript/JavaScript files only..."
# Use xargs to handle long file lists (macOS has argv length limits)
if ! echo "$FILES" | xargs npx eslint; then
  echo ""
  echo "❌ Lint failed. To run full checks locally:"
  echo "   npm run preflight"
  echo ""
  echo "To force push (not recommended):"
  echo "   git push --no-verify"
  exit 1
fi

# Guard: block NEW usage of import.meta.env (existing code is OK)
# This prevents accumulation of direct env access outside the config layer
# See: src/env.ts for the centralized env interface
#
# Exclude comments and string literals to reduce false positives
ADDED=$(git diff --cached -U0 | \
  grep -E '^\+.*import\.meta\.env\.' | \
  grep -vE '^\+\s*//' | \
  grep -vE '^\+\s*/\*' || true)

if [ -n "$ADDED" ]; then
  echo ""
  echo "❌ New import.meta.env detected. Use env helpers instead:"
  echo ""
  echo "$ADDED"
  echo ""
  echo "See src/env.ts for centralized environment access patterns."
  exit 1
fi

exit 0
