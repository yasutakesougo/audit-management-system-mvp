#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -eu

# Pre-push hook: lightweight guard for development
# Full checks (lint, typecheck, build) run in CI via npm run preflight
#
# Strategy:
#   - Local: quick checks on changed files only (fast feedback)
#   - CI: full suite via preflight (complete enforcement)
#   - Never blocks if CI will catch it anyway

# Allow bypass: git push --no-verify
# Troubleshoot: run "npm run preflight" locally to match CI

if [ -n "${CI:-}" ]; then
  # In CI: npm run preflight already handles everything
  # This hook is not typically called during CI push, but if it is, skip it
  exit 0
fi

BASE_REF="${BASE_REF:-origin/main}"

# Determine changed JS/TS files compared to base.
FILES="$(git diff --name-only --diff-filter=ACMR "$BASE_REF...HEAD" -- '*.ts' '*.tsx' '*.js' '*.jsx' || true)"

# If nothing to lint, skip.
if [ -z "$FILES" ]; then
  echo "[pre-push] eslint: skip (no changed JS/TS files vs $BASE_REF)"
  exit 0
fi

echo "[pre-push] eslint: running on changed files vs $BASE_REF"
# shellcheck disable=SC2086
if ! npx eslint --max-warnings=0 --rule 'boundaries/element-types:off' $FILES; then
  echo ""
  echo "❌ Lint failed. To run full checks locally:"
  echo "   npm run preflight"
  echo ""
  echo "To force push (not recommended):"
  echo "   git push --no-verify"
  exit 1
fi

# Guard: block NEW usage of import.meta.env (existing code is OK)
# This prevents accumulation of direct env access outside the config layer
# Exception: src/env.ts (centralized env helpers - the official entry point)
# All other files should import from env helpers, not access import.meta.env directly
#
# Exclude comments and string literals to reduce false positives
ADDED=$(git diff "$BASE_REF...HEAD" -U0 | \
  grep -E '^\+.*import\.meta\.env\.' | \
  grep -vE '^\+\s*//' | \
  grep -vE '^\+\s*/\*' || true)

if [ -n "$ADDED" ]; then
  echo ""
  echo "❌ New import.meta.env detected. Use env helpers instead:"
  echo ""
  echo "$ADDED"
  echo ""
  echo "See src/env.ts for centralized environment access patterns."
  exit 1
fi

exit 0
