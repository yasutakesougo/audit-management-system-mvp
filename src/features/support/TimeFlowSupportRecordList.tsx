import {
    Add as AddIcon,
    Edit as EditIcon,
    ExpandLess as ExpandLessIcon,
    ExpandMore as ExpandMoreIcon,
    Note as NoteIcon,
    Person as PersonIcon,
    Schedule as ScheduleIcon,
    Visibility as VisibilityIcon,
    Work as WorkIcon
} from '@mui/icons-material';
import {
    Alert,
    Avatar,
    Box,
    Button,
    Card,
    CardContent,
    Chip,
    Collapse,
    Divider,
    IconButton,
    LinearProgress,
    Paper,
    Stack,
    Typography
} from '@mui/material';
import React, { useState } from 'react';
import TimeBasedSupportRecordForm from './TimeBasedSupportRecordForm';
import { DailySupportRecord, SupportRecord, SupportRecordTimeSlot } from './types';

// ÊîØÊè¥Ê¥ªÂãï„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂûãÂÆöÁæ©
interface SupportActivityTemplate {
  id: string;
  activityName: string;
  specificTime: string;
  duration: number;
  importance: 'ÂøÖÈ†à' | 'Êé®Â•®' | '‰ªªÊÑè';
  description: string;
  userExpectedActions: string;
  staffSupportMethods: string;
  iconEmoji?: string;
}

// „Éá„Éï„Ç©„É´„ÉàÊîØÊè¥Ê¥ªÂãï„ÉÜ„É≥„Éó„É¨„Éº„Éà
const defaultSupportActivities: SupportActivityTemplate[] = [
  {
    id: 'morning-arrival',
    activityName: 'Êúù„ÅÆÂèó„ÅëÂÖ•„Çå',
    specificTime: '09:00',
    duration: 30,
    importance: 'ÂøÖÈ†à',
    description: 'Êúù„ÅÆÂÅ•Â∫∑Á¢∫Ë™ç„Å®‰∏ÄÊó•„ÅÆÊ∫ñÂÇô',
    userExpectedActions: 'Êå®Êã∂„Çí„Åó„Å¶„ÄÅÊåÅ„Å°Áâ©„ÇíÊï¥ÁêÜ„Åô„Çã',
    staffSupportMethods: '‰ΩìË™øÁ¢∫Ë™ç„ÄÅÊåÅ„Å°Áâ©„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅ‰∏ÄÊó•„ÅÆ‰∫àÂÆöË™¨Êòé',
    iconEmoji: 'üåÖ'
  },
  {
    id: 'morning-activity',
    activityName: 'ÂçàÂâç„ÅÆÊ¥ªÂãï',
    specificTime: '10:00',
    duration: 90,
    importance: 'ÂøÖÈ†à',
    description: 'ÂÄãÂà•ÊîØÊè¥Ë®àÁîª„Å´Âü∫„Å•„ÅèÊ¥ªÂãï',
    userExpectedActions: 'Ë®àÁîª„Åï„Çå„ÅüÊ¥ªÂãï„Å´ÂèÇÂä†„Åô„Çã',
    staffSupportMethods: 'Ê¥ªÂãï„ÅÆË™¨Êòé„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶ÊîØÊè¥',
    iconEmoji: 'üéØ'
  },
  {
    id: 'lunch',
    activityName: 'ÊòºÈ£ü',
    specificTime: '12:00',
    duration: 60,
    importance: 'ÂøÖÈ†à',
    description: 'È£ü‰∫ã„ÅÆÊôÇÈñì',
    userExpectedActions: 'ÊâãÊ¥ó„ÅÑ„Çí„Åó„Å¶„ÄÅÈ£ü‰∫ã„ÇíÊëÇ„Çã',
    staffSupportMethods: 'È£ü‰∫ã„ÅÆÊ∫ñÂÇô„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶È£ü‰∫ã‰ªãÂä©',
    iconEmoji: 'üçΩÔ∏è'
  },
  {
    id: 'afternoon-activity',
    activityName: 'ÂçàÂæå„ÅÆÊ¥ªÂãï',
    specificTime: '13:30',
    duration: 120,
    importance: 'Êé®Â•®',
    description: 'Ââµ‰ΩúÊ¥ªÂãï„ÇÑÁ§æ‰ºöÂèÇÂä†Ê¥ªÂãï',
    userExpectedActions: 'Ê¥ªÂãï„Å´ÈõÜ‰∏≠„Åó„Å¶Âèñ„ÇäÁµÑ„ÇÄ',
    staffSupportMethods: 'Ââµ‰ΩúÊîØÊè¥„ÄÅ„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥‰øÉÈÄ≤',
    iconEmoji: 'üé®'
  },
  {
    id: 'snack-break',
    activityName: '„Åä„ÇÑ„Å§„ÅÆÊôÇÈñì',
    specificTime: '15:00',
    duration: 30,
    importance: '‰ªªÊÑè',
    description: '‰ºëÊÜ©„Å®„É™„Éï„É¨„ÉÉ„Ç∑„É•',
    userExpectedActions: '„Åä„ÇÑ„Å§„ÇíÊ•Ω„Åó„ÇÄ„ÄÅ‰ºëÊÜ©„Åô„Çã',
    staffSupportMethods: '„Åä„ÇÑ„Å§„ÅÆÊ∫ñÂÇô„ÄÅ„É™„É©„ÉÉ„ÇØ„Çπ„Åß„Åç„ÇãÁí∞Â¢É‰Ωú„Çä',
    iconEmoji: '‚òï'
  },
  {
    id: 'end-of-day',
    activityName: 'Â∏∞„Çä„ÅÆÊ∫ñÂÇô',
    specificTime: '16:00',
    duration: 30,
    importance: 'ÂøÖÈ†à',
    description: '‰∏ÄÊó•„ÅÆÊåØ„ÇäËøî„Çä„Å®Â∏∞ÂÆÖÊ∫ñÂÇô',
    userExpectedActions: 'ÊåÅ„Å°Áâ©„Çí„Åæ„Å®„ÇÅ„Å¶„ÄÅÊå®Êã∂„Çí„Åô„Çã',
    staffSupportMethods: '‰∏ÄÊó•„ÅÆÊåØ„ÇäËøî„Çä„ÄÅÊåÅ„Å°Áâ©„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅ„ÅäËøé„ÅàÂØæÂøú',
    iconEmoji: 'üëã'
  }
];

interface TimeFlowSupportRecordListProps {
  dailyRecord: DailySupportRecord;
  onAddRecord: (record: SupportRecord) => void;
  onUpdateRecord: (record: SupportRecord) => void;
}

const TimeFlowSupportRecordList: React.FC<TimeFlowSupportRecordListProps> = ({
  dailyRecord,
  onAddRecord,
  onUpdateRecord
}) => {
  const [formOpen, setFormOpen] = useState(false);
  const [selectedActivity, setSelectedActivity] = useState<SupportActivityTemplate | null>(null);
  const [editingRecord, setEditingRecord] = useState<SupportRecord | null>(null);
  const [expandedCards, setExpandedCards] = useState<Set<string>>(new Set());

  // „Éá„Éï„Ç©„É´„ÉàÊ¥ªÂãï„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®
  const supportActivities = defaultSupportActivities.map((activity, index) => ({
    ...activity,
    id: `activity-${index + 1}`
  }));

  const getRecordForActivity = (activity: SupportActivityTemplate): SupportRecord | undefined => {
    // ÊôÇÈñìÂ∏Ø„ÇíÊ¥ªÂãïÊôÇÈñì„Åã„ÇâÊé®ÂÆö
    const hour = parseInt(activity.specificTime.split(':')[0]);
    const timeSlot = `${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00`;
    return dailyRecord.records.find(record =>
      record.timeSlot === timeSlot ||
      record.userActivities?.actual?.includes(activity.activityName)
    );
  };

  const handleAddRecord = (activity: SupportActivityTemplate) => {
    setSelectedActivity(activity);
    setEditingRecord(null);
    setFormOpen(true);
  };

  const handleEditRecord = (record: SupportRecord, activity: SupportActivityTemplate) => {
    setSelectedActivity(activity);
    setEditingRecord(record);
    setFormOpen(true);
  };

  const handleSaveRecord = (recordData: Omit<SupportRecord, 'id' | 'createdAt' | 'updatedAt'>) => {
    if (editingRecord) {
      const updatedRecord: SupportRecord = {
        ...editingRecord,
        ...recordData,
        updatedAt: new Date().toISOString()
      };
      onUpdateRecord(updatedRecord);
    } else {
      const newRecord: SupportRecord = {
        ...recordData,
        id: Date.now().toString(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      onAddRecord(newRecord);
    }
  };

  const toggleExpanded = (activityId: string) => {
    const newExpanded = new Set(expandedCards);
    if (newExpanded.has(activityId)) {
      newExpanded.delete(activityId);
    } else {
      newExpanded.add(activityId);
    }
    setExpandedCards(newExpanded);
  };

  const getStatusColor = (status: SupportRecord['status']) => {
    switch (status) {
      case 'Ë®òÈå≤Ê∏à„Åø': return 'success';
      case 'Ë¶ÅÁ¢∫Ë™ç': return 'warning';
      case 'Êú™Ë®òÈå≤': return 'default';
      default: return 'default';
    }
  };

  const getImportanceColor = (importance: string) => {
    switch (importance) {
      case 'ÂøÖÈ†à': return 'error';
      case 'Êé®Â•®': return 'warning';
      case '‰ªªÊÑè': return 'info';
      default: return 'default';
    }
  };

  const getProgressStats = () => {
    const totalActivities = supportActivities.length;
    const recordedActivities = supportActivities.filter(activity => getRecordForActivity(activity)).length;
    const completedActivities = supportActivities.filter(activity => {
      const record = getRecordForActivity(activity);
      return record?.status === 'Ë®òÈå≤Ê∏à„Åø';
    }).length;

    return {
      totalActivities,
      recordedActivities,
      completedActivities,
      progressPercent: (completedActivities / totalActivities) * 100
    };
  };

  const stats = getProgressStats();

  return (
    <Box>
      {/* ÈÄ≤Êçó„Çµ„Éû„É™„Éº */}
      <Paper elevation={2} sx={{ p: 3, mb: 4, bgcolor: 'primary.50' }}>
        <Typography variant="h6" gutterBottom display="flex" alignItems="center" gap={1}>
          <ScheduleIcon color="primary" />
          ‰∏ÄÊó•„ÅÆÊµÅ„Çå - Ë®òÈå≤ÈÄ≤Êçó
        </Typography>
        <Box sx={{ mb: 2 }}>
          <LinearProgress
            variant="determinate"
            value={stats.progressPercent}
            sx={{ height: 8, borderRadius: 4 }}
          />
        </Box>
        <Stack direction="row" spacing={2} sx={{ flexWrap: 'wrap' }}>
          <Chip
            label={`ÂÆå‰∫Ü: ${stats.completedActivities}/${stats.totalActivities}Ê¥ªÂãï`}
            color="success"
          />
          <Chip
            label={`Ë®òÈå≤Ê∏à„Åø: ${stats.recordedActivities}Ê¥ªÂãï`}
            color="info"
          />
          <Chip
            label={`ÈÄ≤Êçó: ${Math.round(stats.progressPercent)}%`}
            color="primary"
          />
        </Stack>
      </Paper>

      {/* ÊôÇÈñì„Éï„É≠„ÉºË°®Á§∫ */}
      <Stack spacing={3}>
        {supportActivities.map((activity) => {
          const record = getRecordForActivity(activity);
          const hasRecord = !!record;
          const isExpanded = expandedCards.has(activity.id);

          return (
            <Card
              key={activity.id}
              elevation={hasRecord ? 3 : 1}
              sx={{
                border: hasRecord ? '2px solid' : '1px solid',
                borderColor: hasRecord ? 'success.main' : 'grey.300',
                transition: 'all 0.3s ease-in-out',
                '&:hover': {
                  elevation: hasRecord ? 4 : 2,
                  transform: 'translateY(-2px)'
                }
              }}
            >
              <CardContent>
                {/* „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜ */}
                <Box display="flex" alignItems="center" justifyContent="space-between" mb={2}>
                  <Box display="flex" alignItems="center" gap={2}>
                    <Avatar sx={{ bgcolor: 'primary.main', fontSize: '1.5rem' }}>
                      {activity.iconEmoji || 'üìÖ'}
                    </Avatar>
                    <Box>
                      <Typography variant="h6" display="flex" alignItems="center" gap={1}>
                        {activity.specificTime} - {activity.activityName}
                        <Chip
                          label={activity.importance}
                          color={getImportanceColor(activity.importance)}
                          size="small"
                        />
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        {activity.description} ({activity.duration}ÂàÜ)
                      </Typography>
                      {hasRecord && (
                        <Chip
                          label={record.status}
                          color={getStatusColor(record.status)}
                          size="small"
                          sx={{ mt: 1 }}
                        />
                      )}
                    </Box>
                  </Box>

                  <Box display="flex" alignItems="center" gap={1}>
                    {hasRecord && (
                      <IconButton
                        onClick={() => toggleExpanded(activity.id)}
                        size="small"
                      >
                        {isExpanded ? <ExpandLessIcon /> : <ExpandMoreIcon />}
                      </IconButton>
                    )}
                    {hasRecord ? (
                      <IconButton
                        onClick={() => handleEditRecord(record, activity)}
                        color="primary"
                      >
                        <EditIcon />
                      </IconButton>
                    ) : (
                      <Button
                        onClick={() => handleAddRecord(activity)}
                        startIcon={<AddIcon />}
                        variant="outlined"
                        size="small"
                      >
                        Ë®òÈå≤
                      </Button>
                    )}
                  </Box>
                </Box>

                {/* Ê¥ªÂãïÂÜÖÂÆπ„ÅÆ„Éó„É¨„Éì„É•„Éº */}
                <Box mb={2}>
                  <Stack direction="row" spacing={2} sx={{ flexWrap: 'wrap' }}>
                    <Box flex={1} minWidth="250px">
                      <Typography variant="subtitle2" color="primary" display="flex" alignItems="center" gap={0.5}>
                        <PersonIcon fontSize="small" />
                        Êú¨‰∫∫„ÅÆ„ÇÑ„Çã„Åì„Å®
                      </Typography>
                      <Typography variant="body2" sx={{ pl: 2, color: 'text.secondary' }}>
                        {activity.userExpectedActions}
                      </Typography>
                    </Box>
                    <Box flex={1} minWidth="250px">
                      <Typography variant="subtitle2" color="secondary" display="flex" alignItems="center" gap={0.5}>
                        <WorkIcon fontSize="small" />
                        ËÅ∑Âì°„ÅÆ„ÇÑ„Çã„Åì„Å®
                      </Typography>
                      <Typography variant="body2" sx={{ pl: 2, color: 'text.secondary' }}>
                        {activity.staffSupportMethods}
                      </Typography>
                    </Box>
                  </Stack>
                </Box>

                {/* Ë®òÈå≤Ë©≥Á¥∞ÔºàÂ±ïÈñãÊôÇÔºâ */}
                <Collapse in={isExpanded && hasRecord}>
                  {hasRecord && record && (
                    <Box>
                      <Divider sx={{ my: 2 }} />
                      <Typography variant="subtitle1" gutterBottom display="flex" alignItems="center" gap={1}>
                        <VisibilityIcon color="primary" />
                        Ë®òÈå≤ÂÜÖÂÆπ
                      </Typography>

                      <Stack spacing={2}>
                        {/* ÂÆüÈöõ„ÅÆÊ¥ªÂãïÂÜÖÂÆπ */}
                        <Box>
                          <Typography variant="subtitle2" fontWeight="bold">ÂÆüÈöõ„ÅÆÊ¥ªÂãï</Typography>
                          <Box pl={2}>
                            {record.userActivities.actual && (
                              <Typography variant="body2">
                                <strong>Êú¨‰∫∫:</strong> {record.userActivities.actual}
                              </Typography>
                            )}
                            {record.staffActivities.actual && (
                              <Typography variant="body2">
                                <strong>ËÅ∑Âì°:</strong> {record.staffActivities.actual}
                              </Typography>
                            )}
                          </Box>
                        </Box>

                        {/* Êú¨‰∫∫„ÅÆÊßòÂ≠ê */}
                        <Box>
                          <Typography variant="subtitle2" fontWeight="bold">Êú¨‰∫∫„ÅÆÊßòÂ≠ê</Typography>
                          <Box pl={2}>
                            {record.userCondition.mood && (
                              <Chip
                                label={`Ê∞óÂàÜ: ${record.userCondition.mood}`}
                                size="small"
                                sx={{ mr: 1, mb: 1 }}
                              />
                            )}
                            {record.userCondition.behavior && (
                              <Typography variant="body2">
                                {record.userCondition.behavior}
                              </Typography>
                            )}
                          </Box>
                        </Box>

                        {/* ÁâπË®ò‰∫ãÈ†Ö */}
                        {(record.specialNotes.incidents || record.specialNotes.concerns ||
                          record.specialNotes.achievements) && (
                          <Box>
                            <Typography variant="subtitle2" fontWeight="bold" display="flex" alignItems="center" gap={0.5}>
                              <NoteIcon fontSize="small" />
                              ÁâπË®ò‰∫ãÈ†Ö
                            </Typography>
                            <Box pl={2}>
                              {record.specialNotes.achievements && (
                                <Alert severity="success" sx={{ mb: 1 }}>
                                  <strong>ËâØ„Åã„Å£„ÅüÁÇπ:</strong> {record.specialNotes.achievements}
                                </Alert>
                              )}
                              {record.specialNotes.incidents && (
                                <Alert severity="info" sx={{ mb: 1 }}>
                                  <strong>ÁâπË®ò‰∫ãÈ†Ö:</strong> {record.specialNotes.incidents}
                                </Alert>
                              )}
                              {record.specialNotes.concerns && (
                                <Alert severity="warning">
                                  <strong>Êá∏Âøµ‰∫ãÈ†Ö:</strong> {record.specialNotes.concerns}
                                </Alert>
                              )}
                            </Box>
                          </Box>
                        )}

                        <Typography variant="caption" color="text.secondary">
                          Ë®òÈå≤ËÄÖ: {record.reporter.name}
                          {record.reporter.role && ` (${record.reporter.role})`}
                        </Typography>
                      </Stack>
                    </Box>
                  )}
                </Collapse>

                {/* Êú™Ë®òÈå≤„ÅÆÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ */}
                {!hasRecord && (
                  <Alert severity="info" sx={{ mt: 2 }}>
                    „Åì„ÅÆÊ¥ªÂãï„ÅÆË®òÈå≤„ÅØ„Åæ„Å†ÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÄåË®òÈå≤„Äç„Éú„Çø„É≥„Åã„ÇâÂÖ•Âäõ„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                  </Alert>
                )}
              </CardContent>
            </Card>
          );
        })}
      </Stack>

      {/* Ë®òÈå≤„Éï„Ç©„Éº„É† */}
      {selectedActivity && (
        <TimeBasedSupportRecordForm
          open={formOpen}
          onClose={() => setFormOpen(false)}
          onSave={handleSaveRecord}
          timeSlot={`${parseInt(selectedActivity.specificTime.split(':')[0]).toString().padStart(2, '0')}:00-${(parseInt(selectedActivity.specificTime.split(':')[0]) + 1).toString().padStart(2, '0')}:00` as SupportRecordTimeSlot}
          initialData={editingRecord || undefined}
          personId={dailyRecord.personId}
          personName={dailyRecord.personName}
          date={dailyRecord.date}
        />
      )}
    </Box>
  );
};

export default TimeFlowSupportRecordList;