import AccessTimeIcon from '@mui/icons-material/AccessTime';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import DeleteIcon from '@mui/icons-material/Delete';
import EditIcon from '@mui/icons-material/Edit';
import MoreVertIcon from '@mui/icons-material/MoreVert';
import NotificationsIcon from '@mui/icons-material/Notifications';
import PersonIcon from '@mui/icons-material/Person';
import RestaurantIcon from '@mui/icons-material/Restaurant';
import WarningIcon from '@mui/icons-material/Warning';
import Avatar from '@mui/material/Avatar';
import Box from '@mui/material/Box';
import Card from '@mui/material/Card';
import CardContent from '@mui/material/CardContent';
import Chip from '@mui/material/Chip';
import Divider from '@mui/material/Divider';
import IconButton from '@mui/material/IconButton';
import Menu from '@mui/material/Menu';
import MenuItem from '@mui/material/MenuItem';
import Stack from '@mui/material/Stack';
import Typography from '@mui/material/Typography';
import React from 'react';
import { DailyStatus, PersonDaily } from '../../domain/daily/types';
import { hasAutoGeneratedContent } from '../handoff/hooks/useImportantHandoffsForDaily';

interface DailyRecordListProps {
  records: PersonDaily[];
  onEdit: (record: PersonDaily) => void;
  onDelete: (recordId: number) => void;
  onOpenAttendance?: (record: PersonDaily) => void;
  onOpenHandoffTimeline?: (record: PersonDaily) => void; // Phase 9: ç”³ã—é€ã‚Šè¡¨ç¤ºç”¨
  loading?: boolean;
  highlightUserId?: string | null;
  highlightDate?: string | null;
  activeHighlightUserId?: string | null; // Phase 2-1: ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºç”¨
}

const statusColors: Record<DailyStatus, 'default' | 'primary' | 'secondary' | 'success' | 'error' | 'info' | 'warning'> = {
  'æœªä½œæˆ': 'default',
  'ä½œæˆä¸­': 'warning',
  'å®Œäº†': 'success'
};

const statusIcons: Record<DailyStatus, React.ReactElement> = {
  'æœªä½œæˆ': <WarningIcon fontSize="small" />,
  'ä½œæˆä¸­': <AccessTimeIcon fontSize="small" />,
  'å®Œäº†': <CheckCircleIcon fontSize="small" />
};

export function DailyRecordList({
  records,
  onEdit,
  onDelete,
  onOpenAttendance,
  onOpenHandoffTimeline, // Phase 9: ç”³ã—é€ã‚Šè¡¨ç¤ºç”¨
  loading = false,
  highlightUserId,
  highlightDate,
  activeHighlightUserId // Phase 2-1: ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºç”¨
}: DailyRecordListProps) {
  const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);
  const [selectedRecord, setSelectedRecord] = React.useState<PersonDaily | null>(null);

  // Utility function for meal amount formatting
  const formatMealAmount = (amount: PersonDaily['data']['mealAmount']) => {
    if (!amount) return 'å®Œé£Ÿ';
    return amount;
  };

  const handleMenuOpen = (event: React.MouseEvent<HTMLElement>, record: PersonDaily) => {
    setAnchorEl(event.currentTarget);
    setSelectedRecord(record);
  };

  const handleMenuClose = () => {
    setAnchorEl(null);
    setSelectedRecord(null);
  };

  const handleEdit = () => {
    if (selectedRecord) {
      onEdit(selectedRecord);
    }
    handleMenuClose();
  };

  const handleDelete = () => {
    if (selectedRecord) {
      onDelete(selectedRecord.id);
    }
    handleMenuClose();
  };

  const handleOpenAttendance = () => {
    if (selectedRecord && onOpenAttendance) {
      onOpenAttendance(selectedRecord);
    }
    handleMenuClose();
  };

  // Phase 9: ç”³ã—é€ã‚Šè¡¨ç¤ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleOpenHandoffTimeline = () => {
    if (selectedRecord && onOpenHandoffTimeline) {
      onOpenHandoffTimeline(selectedRecord);
    }
    handleMenuClose();
  };

  if (loading) {
    return (
      <Box sx={{ textAlign: 'center', py: 4 }} data-testid="daily-record-list-loading">
        <Typography variant="body2" color="text.secondary">
          èª­ã¿è¾¼ã¿ä¸­...
        </Typography>
      </Box>
    );
  }

  if (records.length === 0) {
    return (
      <Box sx={{ textAlign: 'center', py: 4 }} data-testid="daily-record-list-empty">
        <Typography variant="body2" color="text.secondary">
          ã¾ã æ—¥æ¬¡è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
        </Typography>
      </Box>
    );
  }

  return (
    <>
      <Stack spacing={2} data-testid="daily-record-list-container">
        {records.map((record) => {
          // Phase 2-1: Check if this record should be highlighted
          const isHighlighted =
            !!highlightUserId &&
            !!highlightDate &&
            record.personId === highlightUserId &&
            record.date === highlightDate;

          // Phase 2-1: ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›´å¾Œï¼‰
          const isActiveHighlight = activeHighlightUserId === record.personId;

          // Check for problem behaviors
          const hasProblemBehavior =
            !!record.data.problemBehavior &&
            (
              record.data.problemBehavior.selfHarm ||
              record.data.problemBehavior.violence ||
              record.data.problemBehavior.loudVoice ||
              record.data.problemBehavior.pica ||
              record.data.problemBehavior.other
            );

          return (
            <Card
              key={record.id}
              variant="outlined"
              data-testid={`daily-record-card-${record.personId}`}
              {...(isHighlighted && {
                'data-highlighted': 'true',
              })}
              sx={{
                ...(isHighlighted && {
                  borderColor: 'primary.main',
                  boxShadow: 4,
                  backgroundColor: 'rgba(25, 118, 210, 0.04)',
                }),
                ...(isActiveHighlight && {
                  outline: '3px solid',
                  outlineColor: 'warning.main',
                  transition: 'outline 200ms ease',
                }),
              }}
            >
            <CardContent>
              {/* Phase 2-1: ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒŠãƒ¼ */}
              {isActiveHighlight && (
                <Box
                  sx={{
                    mb: 2,
                    p: 1,
                    bgcolor: 'warning.50',
                    borderRadius: 1,
                    border: '1px solid',
                    borderColor: 'warning.200',
                  }}
                  data-testid="daily-highlight-banner"
                >
                  <Typography variant="caption" sx={{ fontWeight: 600, color: 'warning.dark' }}>
                    ğŸ“Œ ç”³ã—é€ã‚Šã‹ã‚‰ç§»å‹•ã—ã¾ã—ãŸ
                  </Typography>
                </Box>
              )}

              {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */}
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 2 }}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }} data-testid={`record-header-${record.id}`}>
                  <Avatar sx={{ width: 32, height: 32, bgcolor: 'primary.main' }}>
                    <PersonIcon fontSize="small" />
                  </Avatar>
                  <Box>
                    <Typography variant="subtitle1" sx={{ fontWeight: 'bold' }} data-testid={`person-name-${record.id}`}>
                      {record.personName}
                    </Typography>
                    <Typography variant="caption" color="text.secondary" data-testid={`person-id-${record.id}`}>
                      ID: {record.personId}
                    </Typography>
                  </Box>
                </Box>

                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                  <Chip
                    icon={statusIcons[record.status]}
                    label={record.status}
                    color={statusColors[record.status]}
                    size="small"
                    data-testid={`status-chip-${record.id}`}
                  />
                  <IconButton
                    size="small"
                    onClick={(e) => handleMenuOpen(e, record)}
                    data-testid={`menu-button-${record.id}`}
                    aria-label={`${record.personName}ã•ã‚“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã`}
                    aria-haspopup="menu"
                  >
                    <MoreVertIcon />
                  </IconButton>
                </Box>
              </Box>

              {/* åŸºæœ¬æƒ…å ± */}
              <Stack direction="row" spacing={2} sx={{ mb: 2 }}>
                <Typography variant="body2">
                  <strong>æ—¥ä»˜:</strong> {record.date}
                </Typography>
                <Typography variant="body2">
                  <strong>è¨˜éŒ²è€…:</strong> {record.reporter.name}
                </Typography>
              </Stack>

              <Divider sx={{ my: 2 }} />

              {/* æ´»å‹•æƒ…å ± */}
              <Box sx={{ mb: 2 }}>
                <Typography variant="subtitle2" sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 0.5 }}>
                  <AccessTimeIcon fontSize="small" />
                  æ´»å‹•è¨˜éŒ²
                </Typography>

                {record.data.amActivities.length > 0 && (
                  <Box sx={{ mb: 1 }}>
                    <Typography variant="caption" color="text.secondary">åˆå‰:</Typography>
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5, mt: 0.5 }}>
                      {record.data.amActivities.map((activity, index) => (
                        <Chip
                          key={index}
                          label={activity}
                          size="small"
                          variant="outlined"
                        />
                      ))}
                    </Box>
                  </Box>
                )}

                {record.data.pmActivities.length > 0 && (
                  <Box sx={{ mb: 1 }}>
                    <Typography variant="caption" color="text.secondary">åˆå¾Œ:</Typography>
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5, mt: 0.5 }}>
                      {record.data.pmActivities.map((activity, index) => (
                        <Chip
                          key={index}
                          label={activity}
                          size="small"
                          variant="outlined"
                        />
                      ))}
                    </Box>
                  </Box>
                )}
              </Box>

              {/* é£Ÿäº‹æƒ…å ± */}
              <Box sx={{ mb: 2 }}>
                <Typography variant="subtitle2" sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 0.5 }}>
                  <RestaurantIcon fontSize="small" />
                  é£Ÿäº‹è¨˜éŒ²
                </Typography>
                <Chip
                  label={`é£Ÿäº‹æ‘‚å–é‡: ${formatMealAmount(record.data.mealAmount)}`}
                  size="small"
                  color="primary"
                  variant="outlined"
                />
              </Box>

              {/* å•é¡Œè¡Œå‹• */}
              {hasProblemBehavior && (
                <Box sx={{ mb: 2 }}>
                  <Stack direction="row" spacing={1} flexWrap="wrap">
                    {record.data.problemBehavior?.selfHarm && (
                      <Chip label="è‡ªå‚·" size="small" color="warning" />
                    )}
                    {record.data.problemBehavior?.violence && (
                      <Chip label="æš´åŠ›" size="small" color="warning" />
                    )}
                    {record.data.problemBehavior?.loudVoice && (
                      <Chip label="å¤§å£°" size="small" color="warning" />
                    )}
                    {record.data.problemBehavior?.pica && (
                      <Chip label="ç•°é£Ÿ" size="small" color="warning" />
                    )}
                    {record.data.problemBehavior?.other && (
                      <Chip label="ãã®ä»–" size="small" color="warning" />
                    )}
                  </Stack>
                </Box>
              )}

              {/* ç™ºä½œè¨˜éŒ² */}
              {record.data.seizureRecord?.occurred && (
                <Box sx={{ mb: 2 }}>
                  <Chip
                    label={`ç™ºä½œã‚ã‚Š${record.data.seizureRecord.severity ? ` (${record.data.seizureRecord.severity})` : ''}`}
                    size="small"
                    color="error"
                    icon={<WarningIcon />}
                  />
                </Box>
              )}

              {/* ç‰¹è¨˜äº‹é … */}
              {record.data.specialNotes && (
                <Box>
                  <Typography variant="subtitle2" sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 0.5 }}>
                    ç‰¹è¨˜äº‹é …
                    {/* Phase 9: ç”³ã—é€ã‚Šè‡ªå‹•è»¢è¨˜è¡¨ç¤º */}
                    {hasAutoGeneratedContent(record.data.specialNotes) && (
                      <Chip
                        label="ç”³ã—é€ã‚Šé€£æº"
                        size="small"
                        color="info"
                        icon={<NotificationsIcon />}
                        variant="outlined"
                      />
                    )}
                  </Typography>
                  <Typography variant="body2" color="text.secondary" sx={{ whiteSpace: 'pre-line' }}>
                    {record.data.specialNotes}
                  </Typography>
                </Box>
              )}

              {/* ãƒ¡ãƒ¢ */}
              {(record.data.amNotes || record.data.pmNotes) && (
                <Box sx={{ mt: 2 }}>
                  {record.data.amNotes && (
                    <Typography variant="caption" display="block" color="text.secondary">
                      åˆå‰ãƒ¡ãƒ¢: {record.data.amNotes}
                    </Typography>
                  )}
                  {record.data.pmNotes && (
                    <Typography variant="caption" display="block" color="text.secondary">
                      åˆå¾Œãƒ¡ãƒ¢: {record.data.pmNotes}
                    </Typography>
                  )}
                </Box>
              )}
            </CardContent>
          </Card>
          );
        })}
      </Stack>

      {/* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleMenuClose}
        data-testid="record-menu"
        MenuListProps={{
          'aria-label': `${selectedRecord?.personName || ''}ã•ã‚“ã®æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼`,
        }}
      >
        <MenuItem onClick={handleEdit} data-testid={`edit-record-menu-item-${selectedRecord?.id || ''}`}>
          <EditIcon fontSize="small" sx={{ mr: 1 }} />
          ç·¨é›†
        </MenuItem>
        {/* â˜… è¿½åŠ : é€šæ‰€ç®¡ç†ã¸ã®ã‚¯ãƒ­ã‚¹ãƒªãƒ³ã‚¯ */}
        {onOpenAttendance && (
          <MenuItem onClick={handleOpenAttendance} data-testid={`attendance-link-from-activity-${selectedRecord?.id || ''}`}>
            <PersonIcon fontSize="small" sx={{ mr: 1 }} />
            é€šæ‰€çŠ¶æ³ã‚’è¦‹ã‚‹
          </MenuItem>
        )}
        {/* Phase 9: ç”³ã—é€ã‚Šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º */}
        {onOpenHandoffTimeline && (
          <MenuItem onClick={handleOpenHandoffTimeline} data-testid={`handoff-timeline-link-${selectedRecord?.id || ''}`}>
            <NotificationsIcon fontSize="small" sx={{ mr: 1 }} />
            ç”³ã—é€ã‚Šã‚’è¦‹ã‚‹
          </MenuItem>
        )}
        <MenuItem onClick={handleDelete} sx={{ color: 'error.main' }} data-testid={`delete-record-menu-item-${selectedRecord?.id || ''}`}>
          <DeleteIcon fontSize="small" sx={{ mr: 1 }} />
          å‰Šé™¤
        </MenuItem>
      </Menu>
    </>
  );
}