import { describe, expect, it } from 'vitest';
import {
    buildSpecialNotesFromImportantHandoffs,
    hasAutoGeneratedContent,
    removeAutoGeneratedContent,
    shouldAutoGenerateSpecialNotes,
    type ImportantHandoffForDaily
} from '../useImportantHandoffsForDaily';

describe('useImportantHandoffsForDaily utilities', () => {
  const mockHandoffs: ImportantHandoffForDaily[] = [
    {
      id: 1,
      personId: '001',
      personDisplayName: 'ç”°ä¸­å¤ªéƒ',
      date: '2025-11-18',
      time: '09:30',
      category: 'ä½“èª¿',
      severity: 'é‡è¦',
      message: 'è¡€åœ§ãŒé«˜ã‚ã§æ³¨æ„ãŒå¿…è¦',
      timeBand: 'åˆå‰',
      status: 'æœªå¯¾å¿œ'
    },
    {
      id: 2,
      personId: '001',
      personDisplayName: 'ç”°ä¸­å¤ªéƒ',
      date: '2025-11-18',
      time: '14:15',
      category: 'è¡Œå‹•é¢',
      severity: 'é‡è¦',
      message: 'ä»–åˆ©ç”¨è€…ã¨ã®è¡çªãŒã‚ã£ãŸ',
      timeBand: 'åˆå¾Œ',
      status: 'å¯¾å¿œä¸­'
    }
  ];

  describe('buildSpecialNotesFromImportantHandoffs', () => {
    it('should generate formatted special notes from handoffs', () => {
      const result = buildSpecialNotesFromImportantHandoffs(mockHandoffs);

      expect(result).toContain('ã€ç”³ã—é€ã‚Šï¼ˆé‡è¦ï¼‰ã‹ã‚‰è‡ªå‹•è»¢è¨˜ã€‘');
      expect(result).toContain('ãƒ»âš ï¸ 09:30 ä½“èª¿ï¼šè¡€åœ§ãŒé«˜ã‚ã§æ³¨æ„ãŒå¿…è¦');
      expect(result).toContain('ãƒ»ğŸ”„ 14:15 è¡Œå‹•é¢ï¼šä»–åˆ©ç”¨è€…ã¨ã®è¡çªãŒã‚ã£ãŸ');
    });

    it('should append to existing notes', () => {
      const existing = 'æ‰‹å‹•ã§å…¥åŠ›ã•ã‚ŒãŸç‰¹è¨˜äº‹é …';
      const result = buildSpecialNotesFromImportantHandoffs(mockHandoffs, existing);

      expect(result).toContain(existing);
      expect(result).toContain('ã€ç”³ã—é€ã‚Šï¼ˆé‡è¦ï¼‰ã‹ã‚‰è‡ªå‹•è»¢è¨˜ã€‘');
    });

    it('should return existing notes when no handoffs', () => {
      const existing = 'æ—¢å­˜ã®ç‰¹è¨˜äº‹é …';
      const result = buildSpecialNotesFromImportantHandoffs([], existing);

      expect(result).toBe(existing);
    });
  });

  describe('shouldAutoGenerateSpecialNotes', () => {
    it('should return true for new record with important handoffs', () => {
      const result = shouldAutoGenerateSpecialNotes(true, '001', '', 2);
      expect(result).toBe(true);
    });

    it('should return false for edit mode', () => {
      const result = shouldAutoGenerateSpecialNotes(false, '001', '', 2);
      expect(result).toBe(false);
    });

    it('should return false when no person selected', () => {
      const result = shouldAutoGenerateSpecialNotes(true, '', '', 2);
      expect(result).toBe(false);
    });

    it('should return false when special notes already exist', () => {
      const result = shouldAutoGenerateSpecialNotes(true, '001', 'æ—¢å­˜ã®ç‰¹è¨˜äº‹é …', 2);
      expect(result).toBe(false);
    });

    it('should return false when no important handoffs', () => {
      const result = shouldAutoGenerateSpecialNotes(true, '001', '', 0);
      expect(result).toBe(false);
    });
  });

  describe('hasAutoGeneratedContent', () => {
    it('should detect auto-generated content', () => {
      const text = `æ‰‹å‹•å…¥åŠ›

ã€ç”³ã—é€ã‚Šï¼ˆé‡è¦ï¼‰ã‹ã‚‰è‡ªå‹•è»¢è¨˜ã€‘
ãƒ»âš ï¸ 09:30 ä½“èª¿ï¼šè¡€åœ§ãŒé«˜ã‚ã§æ³¨æ„ãŒå¿…è¦`;

      const result = hasAutoGeneratedContent(text);
      expect(result).toBe(true);
    });

    it('should return false for manual content only', () => {
      const text = 'æ‰‹å‹•ã§å…¥åŠ›ã•ã‚ŒãŸç‰¹è¨˜äº‹é …ã®ã¿';
      const result = hasAutoGeneratedContent(text);
      expect(result).toBe(false);
    });
  });

  describe('removeAutoGeneratedContent', () => {
    it('should remove auto-generated content', () => {
      const text = `æ‰‹å‹•å…¥åŠ›ã®ç‰¹è¨˜äº‹é …

ã€ç”³ã—é€ã‚Šï¼ˆé‡è¦ï¼‰ã‹ã‚‰è‡ªå‹•è»¢è¨˜ã€‘
ãƒ»âš ï¸ 09:30 ä½“èª¿ï¼šè¡€åœ§ãŒé«˜ã‚ã§æ³¨æ„ãŒå¿…è¦
ãƒ»ğŸ”„ 14:15 è¡Œå‹•é¢ï¼šä»–åˆ©ç”¨è€…ã¨ã®è¡çªãŒã‚ã£ãŸ`;

      const result = removeAutoGeneratedContent(text);
      expect(result).toBe('æ‰‹å‹•å…¥åŠ›ã®ç‰¹è¨˜äº‹é …');
    });

    it('should return original text when no auto-generated content', () => {
      const text = 'æ‰‹å‹•ã§å…¥åŠ›ã•ã‚ŒãŸç‰¹è¨˜äº‹é …ã®ã¿';
      const result = removeAutoGeneratedContent(text);
      expect(result).toBe(text);
    });
  });
});