name: Quality Gates
on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      ref:
        description: "Target ref (branch or tag)"
        required: false
        default: ""

concurrency:
  group: quality-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # Phase 2: E2E feature flag guards
      E2E_FEATURE_SCHEDULE_NAV: "1"
      E2E_FEATURE_SCHEDULE_ACCEPTANCE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}
      - name: Detect changes (paths-filter)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            playwright:
              - 'src/**'
              - 'tests/e2e/**'
              - 'playwright*.ts'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'package-lock.json'
              - 'yarn.lock'
              - '.github/workflows/**'
              - 'vite.config.*'
              - 'vitest.config.*'
              - 'public/**'
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install deps
        run: npm ci
      - name: Install Playwright browsers
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true')
        run: npx playwright install --with-deps
      - name: Typecheck
        run: npm run typecheck
      - name: Lint
        run: npm run lint
      - name: Schedules mini tests (optional)
        run: npm run test:schedule:mini
        continue-on-error: true
      - name: Attendance mini tests (optional)
        run: npm run test:attendance:mini
        continue-on-error: true
      - name: Daily mini tests (optional)
        run: npm run test:daily:mini
        continue-on-error: true
      - name: Users mini tests (optional)
        run: npm run test:users:mini
        continue-on-error: true
      - name: Nurse mini tests (optional)
        run: npm run test:nurse:mini
        continue-on-error: true
      - name: Test (coverage)
        run: npm run test:coverage -- --reporter=default
      - name: Start dev server (5173, strict)
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true')
        run: |
          lsof -ti :5173 | xargs -r kill -9 || true
          nohup npm run dev:5173 </dev/null > /tmp/vite-5173.log 2>&1 &
          echo "Vite starting on port 5173..."
      - name: Wait for dev server (5173)
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true')
        run: |
          npx wait-on http://127.0.0.1:5173/ --timeout 60000
          curl -I http://127.0.0.1:5173/ | head -5
      - name: Debug server logs on failure (5173)
        if: failure() && (github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true'))
        run: |
          echo "=== /tmp/vite-5173.log (tail -200) ==="
          tail -200 /tmp/vite-5173.log || true
      - name: Playwright E2E
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true')
        env:
          VITE_E2E: "1"
          VITE_SKIP_LOGIN: "1"
          VITE_E2E_MSAL_MOCK: "1"
          VITE_SKIP_SHAREPOINT: "1"
          VITE_MSAL_CLIENT_ID: "dummy"
          VITE_MSAL_TENANT_ID: "dummy"
          VITE_SCHEDULES_TZ: "Asia/Tokyo"
          VITE_SP_SCOPE_DEFAULT: ${{ secrets.VITE_SP_SCOPE_DEFAULT }}
          VITE_SP_RESOURCE: ${{ vars.VITE_SP_RESOURCE }}
          VITE_SP_SITE_RELATIVE: ${{ vars.VITE_SP_SITE_RELATIVE }}
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5173
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          export VITE_SP_RESOURCE="${VITE_SP_RESOURCE:-https://contoso.sharepoint.com}"
          export VITE_SP_SITE_RELATIVE="${VITE_SP_SITE_RELATIVE:-/sites/Audit}"
          export VITE_SP_SCOPE_DEFAULT="${VITE_SP_SCOPE_DEFAULT:-https://contoso.sharepoint.com/AllSites.Read}"

          echo "VITE_SP_SCOPE_DEFAULT set? -> $([ -n "${VITE_SP_SCOPE_DEFAULT}" ] && echo yes || echo no)"
          echo "VITE_SP_SCOPE_DEFAULT length -> ${#VITE_SP_SCOPE_DEFAULT}"
          echo "VITE_SP_RESOURCE -> ${VITE_SP_RESOURCE}"
          echo "VITE_SP_SITE_RELATIVE -> ${VITE_SP_SITE_RELATIVE}"

          # Run only the lightest Playwright smoke to keep Quality Gates aligned with this PR scope.
          npx playwright test tests/e2e/basic-smoke.spec.ts --config=playwright.smoke.config.ts --project=smoke
      - name: Perf report (LHCI + Web Vitals)
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && steps.changes.outputs.playwright == 'true')
        run: npm run -s ci:perf-report
        env:
          VITE_E2E_MSAL_MOCK: "1"
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      - name: Upload perf summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-summary
          path: |
            reports/perf-summary.md
            reports/perf-summary.json
            lhci-results.json
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: lcov.info
          path: coverage/lcov.info
          if-no-files-found: warn
      - name: Coverage summary
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            pct=$(node -e "const s=require('./coverage/coverage-summary.json');console.log(s.total.lines.pct)")
            {
              echo "### Coverage"
              echo "**Lines:** ${pct}%  "
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### Coverage"
              echo "coverage summary not found"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

  canary:
    runs-on: ubuntu-latest
    needs: quality
    if: github.ref == 'refs/heads/main'
    env:
      VITE_FEATURE_SCHEDULES: "true"
      NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      VITE_SP_SCOPE_DEFAULT: ${{ secrets.VITE_SP_SCOPE_DEFAULT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Start dev server (5173, strict)
        run: |
          lsof -ti :5173 | xargs -r kill -9 || true
          nohup npm run dev:5173 </dev/null > /tmp/vite-5173.log 2>&1 &
          echo "Vite starting on port 5173..."
      - name: Wait for dev server (5173)
        run: |
          npx wait-on http://127.0.0.1:5173/ --timeout 60000
          curl -I http://127.0.0.1:5173/ | head -5
      - name: Debug server logs on failure (5173)
        if: failure()
        run: |
          echo "=== /tmp/vite-5173.log (tail -200) ==="
          tail -200 /tmp/vite-5173.log || true
      - name: Canary checks (E2E + LHCI + Summary)
        id: canary
        run: |
          set +e
          status=0

          export VITE_SP_RESOURCE="${VITE_SP_RESOURCE:-https://contoso.sharepoint.com}"
          export VITE_SP_SITE_RELATIVE="${VITE_SP_SITE_RELATIVE:-/sites/Audit}"
          export VITE_SP_SCOPE_DEFAULT="${VITE_SP_SCOPE_DEFAULT:-https://contoso.sharepoint.com/AllSites.Read}"

          npm run ci:e2e -- --grep-invert @seed --grep-invert @csp
          exit_code=$?
          if [ "$exit_code" -ne 0 ]; then
            status="$exit_code"
          fi

          npm run ci:lh
          exit_code=$?
          if [ "$exit_code" -ne 0 ] && [ "$status" -eq 0 ]; then
            status="$exit_code"
          fi

          npm run perf:summary
          exit_code=$?
          if [ "$exit_code" -ne 0 ] && [ "$status" -eq 0 ]; then
            status="$exit_code"
          fi

          if [ "$status" -ne 0 ]; then
            exit "$status"
          fi
        env:
          VITE_E2E: "1"
          VITE_SKIP_LOGIN: "1"
          VITE_E2E_MSAL_MOCK: "1"
          VITE_SKIP_SHAREPOINT: "1"
          VITE_MSAL_CLIENT_ID: "dummy"
          VITE_MSAL_TENANT_ID: "dummy"
          VITE_SCHEDULES_TZ: "Asia/Tokyo"
          VITE_SP_SCOPE_DEFAULT: ${{ secrets.VITE_SP_SCOPE_DEFAULT }}
          VITE_SP_RESOURCE: ${{ vars.VITE_SP_RESOURCE }}
          VITE_SP_SITE_RELATIVE: ${{ vars.VITE_SP_SITE_RELATIVE }}
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      - name: Notify canary failure
        if: failure()
        run: node scripts/notify.mjs --only-on-fail --title "canary(schedule)" --files reports/perf-summary.md
