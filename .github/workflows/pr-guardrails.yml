name: PR Guardrails

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  wrangler-label-guard:
    name: Wrangler label guard
    runs-on: ubuntu-latest
    steps:
      - name: Enforce cf/wrangler label when wrangler.toml changes
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const requiredLabel = 'cf/wrangler';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const touchesWrangler = files.some((file) => file.filename === 'wrangler.toml');
            const labels = (context.payload.pull_request.labels || []).map((label) => label.name);

            if (touchesWrangler && !labels.includes(requiredLabel)) {
              core.setFailed(`wrangler.toml changed but missing required label: ${requiredLabel}`);
              return;
            }

            if (!touchesWrangler && labels.includes(requiredLabel)) {
              core.warning(`Label ${requiredLabel} is set, but wrangler.toml is not changed.`);
            }

            core.info('PR guardrails check passed.');
