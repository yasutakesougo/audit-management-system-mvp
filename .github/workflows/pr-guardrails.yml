name: PR Guardrails

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  wrangler-label-guard:
    name: Wrangler label guard
    runs-on: ubuntu-latest
    steps:
      - name: Enforce cf/wrangler label when wrangler.toml changes
        uses: actions/github-script@v7
        with:
          script: |
            const requiredLabel = 'cf/wrangler';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const touchesWrangler = files.some((file) => file.filename === 'wrangler.toml');
            const labels = (context.payload.pull_request.labels || []).map((label) => label.name);

            if (touchesWrangler && !labels.includes(requiredLabel)) {
              core.setFailed(`wrangler.toml changed but missing required label: ${requiredLabel}`);
              return;
            }

            if (!touchesWrangler && labels.includes(requiredLabel)) {
              core.warning(`Label ${requiredLabel} is set, but wrangler.toml is not changed.`);
            }

            core.info('PR guardrails check passed.');

  skill-label-check:
    name: AI Skills protocol check
    runs-on: ubuntu-latest
    steps:
      - name: Check AI Skills section for hardening PRs
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);
            const isHardening = labels.some(l => l.startsWith('hardening-'));
            const isRefactor  = labels.includes('refactor');
            const isAdr       = labels.includes('adr');

            if (!isHardening && !isRefactor && !isAdr) {
              core.info('No skill-required labels found. Skipping check.');
              return;
            }

            const body = context.payload.pull_request.body || '';
            const hasSkillSection = body.includes('AI Skills') || body.includes('Skills:');
            const hasEvidence     = body.includes('Evidence Pack') || body.includes('Evidence');

            if (!hasSkillSection) {
              core.warning(
                `PR has label(s) [${labels.join(', ')}] but AI Skills section is missing. ` +
                'See docs/ai-skills-protocol.md for guidance.'
              );
            }

            if (isHardening && !hasEvidence) {
              core.warning(
                'Hardening PR is missing Evidence Pack. ' +
                'Please document DoD evidence per docs/ai-skills-protocol.md ยง5.'
              );
            }

            if (hasSkillSection) {
              core.info('AI Skills protocol check passed.');
            }
