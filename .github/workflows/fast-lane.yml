name: fast-lane

on:
  push:
    branches: [port/flags, main]
  pull_request:
    branches: [main]

concurrency:
  group: fast-lane-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fast:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      CI: true
      NODE_ENV: test
      VITE_E2E: "1"
      VITE_PREFETCH_HUD: "1"
      PREFETCH_HUD: "1"
      VERBOSE_TESTS: "0"

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: TESTIDS guard
        run: npm run guard:testids

      - name: Typecheck
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Store unit tests (focused)
        run: npm run test:store -- --reporter=dot

      - name: Unit (telemetry fast)
        run: npm run test -- --run tests/unit/nurse.telemetry.spec.ts --reporter=verbose

      - name: Hydration unit budget suite
        run: npm run test:hydration -- --reporter=dot

      - name: Build for E2E
        run: npm run build

      - name: Dev server + Prefetch E2E
        shell: bash
        run: |
          npm run dev > /tmp/dev.log 2>&1 &
          DEV_PID=$!
          sleep 5
          npm run test:e2e:prefetch -- --reporter=line
          TEST_EXIT=$?
          kill $DEV_PID 2>/dev/null || true
          exit $TEST_EXIT

      - name: HUD thresholds E2E
        shell: bash
        run: |
          npm run dev > /tmp/dev.log 2>&1 &
          DEV_PID=$!
          sleep 5
          npx playwright test tests/e2e/hud.thresholds.spec.ts --reporter=line
          TEST_EXIT=$?
          kill $DEV_PID 2>/dev/null || true
          exit $TEST_EXIT

      - name: Users detail flow E2E
        shell: bash
        run: |
          npm run dev > /tmp/dev.log 2>&1 &
          DEV_PID=$!
          sleep 5
          npm run test:e2e:users -- --reporter=line
          TEST_EXIT=$?
          kill $DEV_PID 2>/dev/null || true
          exit $TEST_EXIT

      - name: E2E (nurse BP sync)
        shell: bash
        run: |
          npm run dev > /tmp/dev.log 2>&1 &
          DEV_PID=$!
          sleep 5
          VITE_FEATURE_NURSE=1 VITE_SKIP_LOGIN=1 npx playwright test tests/e2e/nurse.bp.sync.spec.ts --reporter=line
          TEST_EXIT=$?
          kill $DEV_PID 2>/dev/null || true
          exit $TEST_EXIT

      - name: Build + bundle guards
        run: npm run build:ci

      - name: E2E smoke • home tiles
        if: ${{ github.ref == 'refs/heads/main' || github.event_name == 'push' || (github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'run-e2e')) }}
        run: npm run e2e:home-tiles -- --reporter=junit,line --output=test-results/home-tiles --retries=1

      - name: E2E smoke • dashboard tabs
        if: ${{ github.ref == 'refs/heads/main' || github.event_name == 'push' || (github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'run-e2e')) }}
        run: npm run e2e:dashboard-smoke -- --reporter=junit,line --output=test-results/dashboard --retries=1

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            test-results/**
            playwright-report/**
            dist/**
          if-no-files-found: ignore
