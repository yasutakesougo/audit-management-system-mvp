name: schedule-guardrails

on: [push, pull_request]

jobs:
  schedule:
    runs-on: ubuntu-latest
    env:
      VITE_E2E: "1"
      VITE_E2E_MSAL_MOCK: "1"
      VITE_SKIP_SHAREPOINT: "1"
      VITE_SKIP_LOGIN: "1"
      VITE_MSAL_CLIENT_ID: "dummy"
      VITE_MSAL_TENANT_ID: "dummy"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - run: npm ci
      - name: Install Playwright browsers (ensure executables present)
        run: npx playwright install --with-deps chromium
      - name: Verify dependencies (early detection)
        run: |
          npm ls dayjs || true
          node -e "console.log('dayjs resolved:', require.resolve('dayjs'))"
      - name: Start dev server (background)
        run: |
          set -euo pipefail
          nohup npm run dev -- --host 127.0.0.1 --port 5173 --strictPort --clearScreen false > vite-dev.log 2>&1 &
          echo $! > vite-dev.pid
          sleep 2
          echo "Vite PID: $(cat vite-dev.pid)"
          ps -p "$(cat vite-dev.pid)" -o pid,cmd || true
          echo "---- vite-dev.log (head) ----"
          head -n 200 vite-dev.log || true
          echo "---- vite-dev.log (tail) ----"
          tail -n 200 vite-dev.log || true
      - name: Wait for dev server
        run: |
          set -euo pipefail
          echo "probe 127.0.0.1:5173"
          curl -v --max-time 5 http://127.0.0.1:5173/ || true
          echo "probe localhost:5173"
          curl -v --max-time 5 http://localhost:5173/ || true
          npx wait-on --verbose --timeout 180000 http-get://127.0.0.1:5173/
      - name: Dump dev server log on failure
        if: failure()
        run: |
          echo "---- vite-dev.log (tail) ----"
          tail -n 400 vite-dev.log || true
          echo "---- lsof 5173 ----"
          lsof -iTCP:5173 -sTCP:LISTEN || true
      - name: Unit (week overlap)
        run: npm run test:schedule:unit
      - name: E2E (ARIA smoke, fixtures)
        env:
          VITE_SCHEDULE_FIXTURES: "1"
          PLAYWRIGHT_SKIP_BUILD: "1"
          PLAYWRIGHT_WEB_SERVER_URL: "http://127.0.0.1:5173"
          PLAYWRIGHT_WEB_SERVER_COMMAND: "true"
        run: npm run test:schedule:e2e
