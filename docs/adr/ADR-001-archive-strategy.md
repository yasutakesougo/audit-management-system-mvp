# ADR-001: アーカイブ戦略の設計

## Status

Proposed

## Context

監査システムでは継続的にログデータが蓄積されるため、中長期的なデータ管理戦略が必要です。SharePoint Online の制限（リストあたり 30,000,000 アイテム、5,000 アイテム表示制限）や、検索・同期パフォーマンスの観点から適切なアーカイブ戦略を検討する必要があります。

### 現在の状況

- 監査ログは `Audit_Events` SharePoint リストに蓄積
- エントリハッシュによる重複防止機能を実装済み
- インデックス設定（ts, action, entity, entry_hash）でクエリ最適化済み
- ローカル監査ログの同期機能（逐次・バッチ）を実装済み

### 要件

- **データ保持期間**: 法定要件に基づく保存期間（通常 5 年以上）
- **パフォーマンス**: 日常的な検索・同期操作の応答性を維持
- **可用性**: アーカイブされたデータへのアクセス手段を確保
- **整合性**: アーカイブプロセス中のデータ損失を防止
- **復元性**: 必要時にデータを復元可能

## Decision

以下のアーカイブ戦略を採用します：

### 1. アーカイブトリガー

**月次自動アーカイブ**を基本方針とし、以下のトリガーで実行：

- Power Automate フローによる月次スケジュール実行（毎月 1 日 AM 2:00）
- 手動実行オプションも用意（管理者権限）
- リストアイテム数が閾値（例: 15,000 件）に達した場合の緊急アーカイブ

### 2. データ移行方法

**コピー後削除方式**を採用：

1. **ターゲット準備**: `Audit_Events_Archive_YYYYMM` リストを自動作成
2. **データコピー**: 対象期間のアイテムをスキーマごとコピー
3. **整合性検証**: アイテム数、ハッシュ値の照合
4. **元データ削除**: 検証完了後に元リストから削除
5. **ログ記録**: アーカイブ操作自体を `Audit_Events` に記録

### 3. アーカイブ対象の選定

**時系列ベース**で対象を決定：

- 基準日から 3 ヶ月以前のアイテムをアーカイブ対象とする
- `ts`（タイムスタンプ）フィールドを基準に判定
- アーカイブ実行月の前々月以前（例: 10 月実行時は 7 月以前が対象）

### 4. 参照整合性の処理

**ReadOnly アーカイブビュー**を提供：

- アーカイブされたデータは専用の閲覧画面で表示
- 検索機能：日付範囲、アクション、エンティティによるフィルタリング
- CSV エクスポート機能を維持
- 元の監査ログ画面にアーカイブデータへのリンクを表示

### 5. 復元手順

**部分復元機能**を実装：

1. アーカイブリストから復元対象を選択（日付範囲など）
2. 重複チェック（entry_hash による照合）
3. メインリストに逆コピー
4. 整合性検証とログ記録

## 実装計画

### Phase 1: 基盤整備（1-2 ヶ月）

- [ ] アーカイブ対象選定ロジック実装
- [ ] アーカイブリスト自動作成機能
- [ ] データ整合性検証ツール

### Phase 2: 自動化（2-3 ヶ月）

- [ ] Power Automate フロー作成
- [ ] 監視・アラート機能
- [ ] エラーハンドリング強化

### Phase 3: UI/UX 改善（3-4 ヶ月）

- [ ] アーカイブデータ閲覧画面
- [ ] 復元 UI 実装
- [ ] ダッシュボード統合

## Alternative Considered

### 代替案 1: SharePoint のバージョン履歴機能を活用

- **却下理由**: リストアイテム数制限は解決されない

### 代替案 2: Azure SQL Database 外部連携

- **却下理由**: 追加インフラコスト、SharePoint エコシステムからの逸脱

### 代替案 3: 物理削除（アーカイブなし）

- **却下理由**: 法的要件、監査証跡の永続性要求に適合しない

## Consequences

### Positive

- SharePoint リストのパフォーマンス維持
- 法的要件への適合
- データ損失リスクの最小化
- 段階的実装により初期投資を抑制

### Negative

- 実装・保守の複雑性増加
- アーカイブデータ検索時の操作性低下
- 自動化フロー依存による SPOF（Single Point of Failure）リスク

### Risk & Mitigation

- **リスク**: アーカイブ処理中の予期しない中断
- **対策**: 冪等性を持つ処理設計、ロールバック機能、手動復旧手順書の整備

## Implementation Notes

### 技術的考慮事項

- **PnP PowerShell**: アーカイブリスト作成・データ移行
- **Graph API**: 大容量データの効率的な移行
- **Power Platform**: スケジューリング・監視・通知

### 運用考慮事項

- **実行タイミング**: 業務時間外での実行を推奨
- **監視**: アーカイブ成功/失敗の通知設定
- **ドキュメント**: 手動復旧手順書、操作マニュアルの整備

---

## Changelog

- 2024-10-14: Initial draft by system analysis
- TBD: Review and approval by stakeholders
