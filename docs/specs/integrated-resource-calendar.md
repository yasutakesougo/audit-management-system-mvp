# 管理者向け 統合リソースカレンダー（計画ビュー）
_version: 1.0 / last updated: 2025-11-16_

## 0. この文書の位置づけ

- **対象機能**: IntegratedResourceCalendar（Plan + Actual 管理用カレンダー）
- **関連画面**: DailyRecordPage, AttendanceRecordPage
- **想定読者**: 開発者 / PO / 運用管理者
- **実装状況**: Sprint 2完了済み、Sprint 3/4 計画中

## 1. 戦略的概要とアーキテクチャ

### I. 統合リソースカレンダーの戦略的位置づけ

このカレンダーは「計画の作成・編集・実績との照合」を1つの画面で完結させる管理者専用ビューです。

#### 対象ユーザー
- **管理者**: 全スタッフ・全車両の計画作成・調整権限
- **リーダー**: 担当チームの計画作成・調整権限
- **一般職員**: 閲覧のみ（自分の予定確認）

#### 使用シーン
1. **計画段階**: 月次・週次でのリソース配分
2. **実行段階**: 当日のリアルタイム進捗確認
3. **振り返り**: 実績vs計画の差異分析

### II. Plan vs Actual（PvsA）統合アプローチ

```
計画データ              実績データ              統合ビュー
┌─────────┐          ┌─────────┐          ┌──────────────┐
│ Plan     │          │ Actual   │          │ Unified      │
│ - 開始時刻  │   merge   │ - 実開始    │   ──→    │ - 計画時刻     │
│ - 終了時刻  │  ────→  │ - 実終了    │          │ - 実績時刻     │
│ - 担当者   │          │ - ステータス │          │ - 差分・警告   │
│ - 種別    │          │ - 進捗率   │          │ - PvsA表示    │
└─────────┘          └─────────┘          └──────────────┘
```

### III. アーキテクチャ：Pull + Push ハイブリッド

1. **Pull（初期表示・期間変更時）**
   - `/api/events/unified?start={}&end={}` から期間内の全統合データを取得

2. **Push（リアルタイム更新）**
   - WebSocket/SignalR で実績更新を受信
   - FullCalendar API で該当イベントのextendedPropsのみ更新

### IV. データ主権とCRUD責任分離

| 操作 | Plan | Actual | 統合ビュー |
|------|------|--------|----------|
| **作成** | ✅ カレンダー上でドラッグ | ❌ 現場アプリから | 📊 PvsA表示 |
| **更新** | ✅ ドラッグ&ドロップ | ❌ 現場アプリから | 📊 リアルタイム反映 |
| **削除** | ✅ クリック→確認ダイアログ | ❌ 現場アプリから | 📊 ステータス変更 |
| **参照** | 📊 統合ビューで表示 | 📊 統合ビューで表示 | ✅ メイン機能 |

### V. ビジネスルール統合

#### 物理的制約（ハード制約）
- 同一リソースの時間重複禁止
- 車両定員超過禁止
- スタッフ同時配置禁止

#### 運用ルール（ソフト制約）
- 8時間超勤務の警告表示
- 連続勤務日数の警告
- スキル不足の警告

### VI. パフォーマンス戦略

| 要件 | 対応策 |
|------|--------|
| **初期表示 < 500ms** | 期間限定fetch + 仮想化 |
| **実績反映 < 100ms** | Push更新 + 局所再描画 |
| **操作レスポンス瞬時** | optimistic update |

## 2. 機能要件（Functional Requirements）

### FR-1: リソース表示・グルーピング

#### FR-1.1 階層表示
```
📁 スタッフ
├── 👤 田中 (正社員・看護師)
├── 👤 佐藤 (正社員・介護福祉士)
└── 👤 山田 (契約・ヘルパー)

📁 車両
├── 🚗 車両A (定員4名・車椅子対応)
└── 🚗 車両B (定員7名・一般)
```

#### FR-1.2 カスタムカラム
- **スキル**: 看護師/介護福祉士/ヘルパー
- **雇用形態**: 正社員/契約/パート
- **車両仕様**: 定員/車椅子対応/装備

### FR-2: Plan（計画）CRUD

#### FR-2.1 作成（実装済み✅）
- **空白スロットドラッグ**: 30分単位で新規Plan作成
- **モーダル**: 担当者・種別・詳細入力
- **バリデーション**: 必須項目・時間妥当性

#### FR-2.2 更新（実装済み✅）
- **eventDrop**: リソース間移動
- **eventResize**: 開始・終了時間調整
- **制約**: 実績入りPlanは編集不可

#### FR-2.3 削除（実装済み✅）
- **eventClick**: 削除確認ダイアログ表示
- **条件**: 実績未入力のPlanのみ削除可能

### FR-3: PvsA（Plan vs Actual）統合表示

#### FR-3.1 統合データモデル
```typescript
interface UnifiedResourceEvent {
  // 基本情報
  id: string;
  resourceId: string;
  title: string;
  start: string; // 計画開始時刻
  end: string;   // 計画終了時刻

  // UI制御
  className?: string[];
  editable?: boolean;

  extendedProps: {
    // Plan情報
    planId: string;
    planType: 'visit' | 'center' | 'travel' | 'break' | 'admin';

    // Actual情報
    recordId?: string;
    actualStart?: string | null;  // 実績開始
    actualEnd?: string | null;    // 実績終了
    status?: PvsAStatus;          // 進捗状況
    percentComplete?: number;     // 進捗率(0-100)
    notes?: string;               // 実績メモ

    // 計算済み情報
    diffMinutes?: number;         // 計画との差分(分)
  };
}
```

#### FR-3.2 PvsAステータス定義
| Status | 表示 | 条件 | 色 |
|--------|------|------|-----|
| `waiting` | 未開始 | 実績なし | グレー |
| `in-progress` | 実行中 | 開始あり・終了なし | ブルー |
| `completed` | 完了 | 終了あり・差分±5分以内 | グリーン |
| `delayed` | 遅延 | 終了あり・差分+5分超過 | オレンジ |
| `cancelled` | 中止 | キャンセルフラグあり | レッド |

#### FR-3.3 イベント表示カスタマイズ
```
┌─────────────────────┐
│ 🏠 利用者宅訪問        │ ← タイトル
├─────────────────────┤
│ 計画: 09:00-10:00    │ ← 計画時刻
│ 実績: 09:05-10:15    │ ← 実績時刻（あれば）
│ [████████▒▒] 80%    │ ← 進捗バー（実行中）
│ [完了] +15分遅延      │ ← ステータス・差分
└─────────────────────┘
```

### FR-4: インタラクション

#### FR-4.1 新規作成（実装済み✅）
- **dateClick**: 指定時刻にPlan作成モーダル起動
- **select**: ドラッグ範囲でPlan作成モーダル起動

#### FR-4.2 編集（実装済み✅）
- **eventDrop**: ドラッグ&ドロップでリソース・時間変更
- **eventResize**: 端ドラッグで開始・終了時間調整

#### FR-4.3 詳細表示（実装済み✅）
- **eventClick**: Plan詳細・実績情報・削除ボタン表示
- **実績あり**: 実績詳細・差分情報も表示

### FR-5: 警告・例外処理

#### FR-5.1 物理的制約
- **ダブルブッキング禁止**: `eventOverlap={false}`
- **操作時警告**: 競合時にドロップ操作を元に戻し

#### FR-5.2 ビジネスルール警告
- **背景ハイライト**: 8時間超勤務日を薄赤表示
- **サイドパネル警告**: リソースごとの警告集計表示
- **ツールチップ**: 具体的な警告内容表示

#### FR-5.3 データ整合性
- **楽観的ロック**: 同時編集時のetagチェック
- **ロールバック**: API失敗時の画面状態復元

## 3. 実装計画

### Sprint 1: FullCalendar基盤（完了✅）
- FullCalendar v6 + resource-timeline導入
- リソース行表示（staff/vehicle）
- リソースグループ・カスタムカラムの土台

### Sprint 2: Plan CRUD基盤（完了✅）
- Plan CRUD操作（作成・更新・削除）
- 空白スロットドラッグでPlan作成
- イベントドラッグでリソース間移動
- 端ドラッグで時間リサイズ
- 実績イベントは編集不可制御
- クリックで削除ダイアログ
- Zustand状態管理
- モックAPI・ローディング・エラー・スナックバー

### Sprint 3: PvsA統合ビュー（実装予定）
- Issue 2: UnifiedResourceEvent型導入
- Issue 3: PvsAステータス計算ユーティリティ
- Issue 4: eventContentによるPvsA表示
- Issue 5: Plan種別・ステータス色分け
- Issue 6: 実績入りイベント編集制御
- Issue 7: ハイブリッドデータモデル（Pull + Push更新）

### Sprint 4: 警告・ビジネスルール（実装予定）
- Issue 8: 物理的ダブルブッキング禁止
- Issue 9: ビジネスルール警告の背景ハイライト
- Issue 10: eventsSetによるクライアントサイド警告集計

## 4. 技術仕様

### 使用技術スタック
- **UI**: React + TypeScript + Material-UI
- **カレンダー**: FullCalendar v6 + @fullcalendar/resource-timeline
- **状態管理**: Zustand
- **API**: REST + WebSocket（リアルタイム更新）
- **スタイリング**: MUI theming + CSS-in-JS

### パフォーマンス要件
- 初期表示: 500ms以内
- 実績反映: 100ms以内
- 操作レスポンス: 瞬時

### アクセシビリティ
- WAI-ARIA準拠
- キーボード操作対応
- スクリーンリーダー対応

---

**更新履歴**:
- 2025-11-16: 初版作成（Sprint 2完了時点）